---
import BaseLayout from '~/layouts/BaseLayout.astro'
import { changelog, getModule, modules, runs, tools } from '~/data'

export function getStaticPaths() {
  return modules.map((m) => ({ params: { id: m.id } }))
}

const id = Astro.params.id
const module = getModule(id)
if (!module) throw new Error(`Unknown module: ${id}`)

const moduleRuns = runs
  .filter((r) => r.modules.includes(module.id))
  .sort((a, b) => (b.dateRange.start ?? '').localeCompare(a.dateRange.start ?? ''))

const moduleUpdates = changelog
  .filter((c) => c.scope === 'module' && c.moduleId === module.id)
  .sort((a, b) => b.date.localeCompare(a.date))

const relatedTools = tools.filter((t) => t.relatedModules.includes(module.id))
const externalTools = module.externalTools ?? []
---

<BaseLayout title={`${module.title} · 柴火创客学院`} description={module.tagline}>
  <div class="container">
    <section class="hero">
      <div class="kicker">{module.id.toUpperCase()}</div>
      <h1>{module.title}</h1>
      <p>{module.tagline}</p>
      <div class="pill-row">
        <a class="pill" href="/modules">返回模块</a>
        {module.slides.kind !== 'none' && module.slides.url ? (
          <a class="pill" href={module.slides.url} target={module.slides.kind === 'external' ? '_blank' : undefined}>
            进入课件
          </a>
        ) : null}
        <a class="pill" href={module.docs.yuque.overviewUrl} target="_blank">详细培训文档（语雀）</a>
      </div>
    </section>

    <section class="section">
      <div class="section-head">
        <h2>能力路径</h2>
      </div>
      <div class="grid">
        <div class="card" style="grid-column: span 4;">
          <div class="card-inner">
            <div class="kicker">L1</div>
            <h3>单点体验</h3>
            <p>{module.capability.l1}</p>
          </div>
        </div>
        <div class="card" style="grid-column: span 4;">
          <div class="card-inner">
            <div class="kicker">L2</div>
            <h3>场景联动</h3>
            <p>{module.capability.l2}</p>
          </div>
        </div>
        <div class="card" style="grid-column: span 4;">
          <div class="card-inner">
            <div class="kicker">L3</div>
            <h3>业务集成</h3>
            <p>{module.capability.l3}</p>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-head">
        <h2>技术栈</h2>
      </div>
      <div class="card">
        <div class="card-inner">
          <div class="tags">
            {module.stack.map((t) => (
              <span class="tag">{t}</span>
            ))}
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-head">
        <h2>适用场景</h2>
      </div>
      <div class="grid">
        {module.scenarios.map((s) => (
          <div class="card" style="grid-column: span 4;">
            <div class="card-inner">
              <h3>{s}</h3>
            </div>
          </div>
        ))}
      </div>
    </section>

    <section class="section">
      <div class="section-head">
        <h2>授课记录</h2>
        <a href="/runs">全部记录</a>
      </div>
      {moduleRuns.length ? (
        <div class="grid">
          {moduleRuns.map((r) => (
            <div class="card" style="grid-column: span 6;">
              <div class="card-inner">
                <div class="kicker">{r.dateRange.start}{r.type === 'company' ? ' · 企业' : ' · 社区'}</div>
                <h3>{r.orgName ?? r.location ?? r.id}</h3>
                <p>{r.summary}</p>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="card"><div class="card-inner"><p>暂无公开记录（可在 runs.ts 添加）。</p></div></div>
      )}
    </section>

    <section class="section">
      <div class="section-head">
        <h2>更新记录</h2>
        <a href="/changelog">全站更新</a>
      </div>
      {moduleUpdates.length ? (
        <div class="grid">
          {moduleUpdates.map((u) => (
            <div class="card" style="grid-column: span 6;">
              <div class="card-inner">
                <div class="kicker">{u.date}</div>
                <h3>{u.title}</h3>
                <p>{u.summary}</p>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="card"><div class="card-inner"><p>暂无更新（可在 changelog.ts 添加）。</p></div></div>
      )}
    </section>

    <section class="section">
      <div class="section-head">
        <h2>相关工具</h2>
        <a href="/tools">全部工具</a>
      </div>
      {relatedTools.length || externalTools.length ? (
        <div class="grid">
          {relatedTools.map((t) => (
            <div class="card" style="grid-column: span 6;">
              <div class="card-inner">
                <div class="kicker">Tool</div>
                <h3><a href={`/tools/${t.id}`}>{t.name}</a></h3>
                <p>{t.description}</p>
              </div>
            </div>
          ))}
          {externalTools.map((t) => (
            <div class="card" style="grid-column: span 6;">
              <div class="card-inner">
                <div class="kicker">外部工具</div>
                <h3><a href={t.url} target="_blank">{t.name}</a></h3>
                {t.description ? <p>{t.description}</p> : null}
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="card"><div class="card-inner"><p>暂无相关工具。</p></div></div>
      )}
    </section>
  </div>
</BaseLayout>
